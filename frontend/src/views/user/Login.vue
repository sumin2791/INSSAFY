<template>
  <div>
    <b-container>
      <b-row id="container">
        <b-col cols="6" class="banner">
          <div>
            <img src="@/assets/images/logo.png" alt="" width="100%" />
          </div>
          <!-- <h2 class="b-title">for SSAFY</h2> -->
        </b-col>
        <b-col class="login">
          <h2 class="b-title">로그인</h2>
          <p class="b-title">In SSAFY 하시려면 로그인해주세요</p>
          <div class="login-form">
            <div class="login-input">
              <div class="input-with-label">
                <label for="email">이메일</label>
                <input
                  v-model="email"
                  v-bind:class="{
                    error: error.email && email.length !== 0,
                    complete: !error.email && email.length !== 0,
                  }"
                  @keyup.enter="Login"
                  id="email"
                  placeholder="이메일을 입력하세요."
                  type="text"
                  autocapitalize="off"
                />
                <div class="error-text" v-if="error.email && email.length !== 0">{{ error.email }}</div>
              </div>
              <div class="input-with-label">
                <label for="email">비밀번호</label>
                <input
                  v-model="password"
                  type="password"
                  v-bind:class="{
                    error: error.password && password.length !== 0,
                    complete: !error.password && password.length !== 0,
                  }"
                  id="password"
                  @keyup.enter="onLogin"
                  placeholder="비밀번호를 입력하세요."
                />
                <div class="error-text" v-if="error.password && password.length !== 0">{{ error.password }}</div>
              </div>
            </div>
            <button
              id="login-btn"
              class="b-title"
              @click="onLogin"
              :disabled="!isSubmit"
              :class="{ disabled: !isSubmit }"
            >
              Login
            </button>
          </div>
          <div class="etc-options">
            <div class="etc-option-item">
              <!-- <p>아직 회원이 아니신가요?</p> -->
              <router-link to="/join" class="btn-text">회원가입</router-link>
            </div>
            <div class="etc-option-item">
              <!-- <p>비밀번호 잊으셨나요?</p> -->
              <router-link to="" class="btn-text">비밀번호 찾기</router-link>
            </div>
          </div>
        </b-col>
      </b-row>
    </b-container>
  </div>
</template>

<script>
import PV from 'password-validator';
import * as EmailValidator from 'email-validator';

//소켓 설정
// import SockJS from 'sockjs-client';
// import Stomp from 'webstomp-client';

// 채팅방 api
import * as chatApi from '@/api/chat';

export default {
  components: {},
  data: () => {
    return {
      email: '',
      password: '',
      passwordSchema: new PV(),
      error: {
        email: false,
        password: false,
      },
      isSubmit: false,
      component: this,
    };
  },
  computed: {
    nextRoute() {
      // return this.$route.params.nextRoute ? this.$route.params.nextRoute : '';
      return '';
    },
  },
  created() {
    this.component = this;

    this.passwordSchema
      .is()
      .min(8)
      .is()
      .max(100)
      .has()
      .digits()
      .has()
      .letters();
  },
  mounted() {},
  watch: {
    password: function(v) {
      this.checkForm();
    },
    email: function(v) {
      this.checkForm();
    },
  },
  methods: {
    checkForm() {
      this.email = this.email.toLowerCase();
      if (this.email.length >= 0 && !EmailValidator.validate(this.email)) this.error.email = '이메일 형식이 아닙니다.';
      else this.error.email = false;

      if (this.password.length >= 0 && !this.passwordSchema.validate(this.password))
        this.error.password = '영문,숫자 포함 8 자리이상이어야 합니다.';
      else this.error.password = false;

      let isSubmit = true;
      Object.values(this.error).map((v) => {
        if (v) isSubmit = false;
      });
      this.isSubmit = isSubmit;
    },
    onLogin: function() {
      this.$store
        .dispatch('auth/login', {
          email: this.email,
          password: this.password,
        })
        .then((result) => {
          if (result.data.message === 'FAIL') {
            alert('이메일 또는 비밀번호를 다시 확인하여 주십시오.');
            this.password = '';
          } else if (result.data.message === 'NO_AUTH') {
            //이메일 인증 완료 유도를 위해 custom toast 활용
            //toast 내에서 vuex를 활용하여 도메인 링크 동적 생성
            this.$store.commit('setToastTogle');
            this.$store.commit('setToastType', 'email');
            // alert('이메일 인증을 완료해주세요.');
          } else {
            this.$router.replace(`/${this.nextRoute}`);
            // this.$router.push({ name: 'Main' });
            // console.log(this.$store.state.auth.token);
            // console.log(this.$store.state.auth.email);

            // 로그인 ID를 가져온다
            const params = this.$store.state.auth.user.userId;
            // 채팅 알림 연결
            chatApi
              .getNotice(params)
              .then((res) => {
                // console.log(res)
                // res.data.notices (비어있으면 알림 0 아니면 알림 존재)
                // 이 안에 opp_name, count 로 저장되어 있음 - 일단은 이름만 보여주자
                // 알림이 있으면 토스트를 띄워주자
                const notice = res.data.notices;
                if (notice.length) {
                  for (let i = 0; i < notice.length; i++)
                    this.$toast.open({
                      message: `${notice[i].opp_name}님의 메세지`,
                      type: 'info',
                      duration: 4000,
                      // queue: true,
                      // 상대방 닉네임, 내 아이디
                      onClick: () => {
                        this.moveToChatRoom(notice[i].opp_name, params);
                      },
                      position: 'top-right',
                    });
                }
              })
              .catch((err) => {
                console.error(err);
              });
          }
        })
        .catch((err) => {
          console.log(err);
        });
    },

    // 채팅방 이동 및 활성화 - async, await로 구현 가능하면 구현
    moveToChatRoom(opp_name, user_id) {
      // 그리고 라우터 변환
      this.$router.push({ name: 'ChatPage' });
      // 현재 가지고 있는 채팅방을 가져오자
    },
      // chatApi
      //   .getChatList({ user_id: user_id })
      //   .then((res) => {
      //     const chatLists = res.data.roomInfo;
      //     // 방 정보, 상대방 아이디 저장
      //     let chatRoomId;
      //     let oppId;
      //     for (let i = 0; i < chatLists.length; i++) {
      //       if (chatLists[i].opp_nickName === opp_name) {
      //         chatRoomId = chatLists[i].roomId;
      //         oppId = chatLists[i].opp_id;
      //         break;
      //       }
      //     }
      //     // break => 채팅방 존재(vuex 변화)
      //     const existChatRoom = {
      //       roomId: chatRoomId,
      //       opp_nickName: opp_name,
      //       opp_id: oppId,
      //     };
      //     // vuex state 변화
      //     this.$store.dispatch('chat/isSelected', existChatRoom);

      //   })
      //   .catch((err) => {
      //     console.error(err);
      //   });
  },
};
</script>

<style scoped>
#container {
  width: 100%;
  padding: 10px;
  box-shadow: var(--basic-shadow-w);
  box-shadow: var(--basic-shadow-s) !important;
  border-radius: 15px !important;
  background-color: var(--basic-color-bg2) !important;
}
.row {
  margin-top: 50px;
}
.banner {
  display: flex;
  flex-direction: column;
  justify-content: center;
  /* align-items: flex-end; */
  background-color: #fff;
}
.banner h2 {
  text-align: end;
}
.login {
  display: flex;
  flex-direction: column;
  justify-content: center;
  max-width: 580px;
  width: 100%;
  padding-top: 30px;
  padding-bottom: 30px;
  background-color: #fff;
}
h2 {
  margin-bottom: 30px;
}
.login p {
  font-weight: 300;
  margin-bottom: 3rem;
  color: #949590;
}
.login-form {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  /* align-items: center; */
  /* height: 30vh; */
  width: 100%;
}
.login-input {
  width: 100%;
  float: left;
  position: relative;
  margin-bottom: 10px;
}
input {
  background: transparent;
  font-size: 1em;
  width: 100%;
  height: 50px;
  line-height: 1em;
  border: 1px solid #cccccc;
  padding: 0 20px;
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
  -webkit-transition: 0.2s;
  transition: 0.2s;
  outline: none;
}
.etc-options {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  /* margin-top: 10px; */
}
.etc-option-item {
  display: flex;
  justify-content: space-between;
}
.etc-option-item p {
  margin-bottom: 0;
  color: #949590;
}
.etc-option-item a {
  margin: auto 0;
  margin-bottom: 0;
}
.error-text {
  font-size: 0.8rem;
  color: #ff0404;
}
.btn-text {
  color: #949590;
  font-weight: 800;
  text-decoration: none;
}
#login-btn {
  width: 100%;
  height: 40px;
  margin-top: 100px;
  margin-bottom: 20px;
  border: solid 1px #000;
  font-size: 24px;
  transition: color 0.3s, background-color 0.3s ease;
}
#login-btn:hover,
#login-btn:active {
  background-color: #000 !important;
  color: #fff;
}
@media screen and (min-width: 576px) {
  .login {
    display: flex;
    flex-direction: column;
    justify-content: center;
    max-width: 580px;
    width: 100%;
    padding-top: 30px;
    padding-bottom: 30px;
    background-color: #fff;
  }
  .row {
    border: 1px #949590 solid;
  }
}
@media screen and (max-width: 576px) {
  #login-btn {
    background-color: #000 !important;
    color: #fff;
  }
  .banner {
    display: none;
  }
  #container {
    padding: 0px;
    margin: 100px auto;
  }
  .login {
    box-shadow: var(--basic-shadow-w);
    box-shadow: var(--basic-shadow-s);
    border-radius: 15px;
    background-color: var(--basic-color-bg2);
  }
}

/* 스켈레톤에서 가져온거 */
.input-with-label {
  width: 100%;
  float: left;
  position: relative;
  margin-bottom: 10px;
}

.input-with-label input[type='text'],
.input-with-label input[type='password'] {
  width: 100%;
  float: left;
  height: 50px;
  line-height: 1;
  padding: 2px 15px 0 105px;
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
  color: #000;
  border: 1px solid #000;
  border-radius: 3px;
}

.input-with-label input[type='text']:hover,
.input-with-label input[type='text']:focus,
.input-with-label input[type='password']:hover,
.input-with-label input[type='password']:focus {
  border: 2px solid #000;
}

.input-with-label input[type='text'].error,
.input-with-label input[type='password'].error {
  border-radius: 0;
  border: none;
  border-bottom: 1px solid #ee4b55;
}

.input-with-label input[type='text'].complete,
.input-with-label input[type='password'].complete {
  border-radius: 0;
  border: none;
  border-bottom: 1px solid #3893a8;
}

.input-with-label input[type='text'].disabled,
.input-with-label input[type='password'].disabled {
  background: #eee;
  color: #333;
  font-weight: 600;
}

.input-with-label input[type='text'].disabled:hover,
.input-with-label input[type='text'].disabled:focus,
.input-with-label input[type='password'].disabled:hover,
.input-with-label input[type='password'].disabled:focus {
  border: 1px solid #000;
}

.input-with-label label {
  position: absolute;
  left: 15px;
  top: 19px;
  color: #000;
  font-weight: 600;
  font-size: 0.857em;
}

.input-with-label h4 {
  text-overflow: ellipsis;
  white-space: nowrap;
  overflow: hidden;
  word-wrap: normal;
}

.input-with-label .error-text {
  width: 100%;
  float: left;
  color: #ee4b55;
  margin-top: 3px;
}

.label-with-input {
  width: 100%;
  float: left;
  margin-bottom: 15px;
}

.label-with-input label {
  font-size: 1em;
  font-weight: 600;
  margin-bottom: 10px;
  display: block;
}

.label-with-input input[type='text'] {
  width: 100%;
  float: left;
}

.label-with-input input[type='text'].error {
  border-color: #ee4b55;
}

.label-with-input:last-of-type {
  margin-bottom: 0;
}

.label-with-input .error-text {
  width: 100%;
  float: left;
  color: #ee4b55;
  margin-top: 3px;
}
</style>
